name: CI/CD - Web App

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: euhub-chatbot
  REGION: europe-west1
  SERVICE_NAME: aiops-mike-dev
  ARTIFACT_REGISTRY: europe-west1-docker.pkg.dev/euhub-chatbot/aiops-mike-dev
  IMAGE_NAME: aiops-mike-dev
  RUNTIME_SERVICE_ACCOUNT: "euhub-bot-runtime@euhub-chatbot.iam.gserviceaccount.com"

jobs:
  ci:
    name: Build & Push
    runs-on: ubuntu-latest
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGION }}-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  cd:
    name: Deploy to Cloud Run
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify required config
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          test -n "${{ env.RUNTIME_SERVICE_ACCOUNT }}" || (echo "Missing variable: RUNTIME_SERVICE_ACCOUNT" && exit 1)
          test -n "$GCP_SA_KEY" || (echo "Missing secret: GCP_SA_KEY" && exit 1)

      - name: Deploy to Cloud Run
        run: |
          IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.IMAGE_NAME }}"
          DIGEST="${{ needs.ci.outputs.image_digest }}"
          
          # Check if service exists
          if gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(name)" 2>/dev/null; then
            
            # Service exists - update image and ensure correct configuration
            echo "Service exists, updating image and configuration..."
            gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image="${IMAGE}@${DIGEST}" \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --platform=managed \
              --service-account=${{ env.RUNTIME_SERVICE_ACCOUNT }} \
              --memory=1Gi \
              --cpu=1 \
              --timeout=3600 \
              --max-instances=10 \
              --quiet
          else
            # Service doesn't exist - create with full configuration
            echo "Service doesn't exist, creating with full configuration..."
            gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image="${IMAGE}@${DIGEST}" \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --platform=managed \
              --allow-unauthenticated \
              --service-account=${{ env.RUNTIME_SERVICE_ACCOUNT }} \
              --port=3000 \
              --memory=1Gi \
              --cpu=1 \
              --timeout=3600 \
              --min-instances=0 \
              --max-instances=10 \
              --quiet
          fi

          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --to-latest \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --quiet
